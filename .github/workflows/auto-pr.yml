name: "auto-pr: dev to main"

on:
  push:
    branches:
      - dev

permissions:
  contents: write
  pull-requests: write    

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get all commits to compare branches
      
      - name: Calculate Deploy/Build Version
        id: deploy_build_versioning
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the number of previous deploys
          DEPLOY_COUNT=$(gh run list --workflow "heroku-deploy.yml" --status success --json conclusion --limit 1000 | jq '. | length'  || echo 0)
          
          # DEPLOY_COUNT+=1 for next deploy
          echo "VERSION=$((DEPLOY_COUNT + 1))" >> "$GITHUB_OUTPUT"

      - name: Generate Commit Summary
        id: commit_summary
        run: |
          # Get all commit messages between main and dev
          # Format: * ShortHash - Message (Author)
          git fetch origin main:main
          
          COMMITS=$(git log origin/main..origin/dev --oneline --no-merges --pretty=format:"* %h - %s")

          if [ -z "$COMMITS" ]; then
            COMMITS="* No new commits found (likely a fast-forward or metadata change)."
          fi
          
          # Handle multi-line strings for GitHub Actions output
          {
            echo "COMMIT_LOGS<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.HARMONY_AUTO_PR_PAT }}
          branch: dev
          base: main
          title: "build/deploy: Harmony v${{ steps.deploy_build_versioning.outputs.VERSION }}"
          body: |
            ## Auto-PR from `dev` âž” `main`
            This PR was automatically generated because new code was pushed to the `dev` branch.

            ### Commits (change log)
            ${{ steps.commit_summary.outputs.COMMIT_LOGS }}
            
          labels: |
            automated-pr
            release